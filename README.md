# GloolaServer

The server uses RESTful API to administrate several collections of entities, as following.

## Authentication with JWT
At the beginning of a session, the client must first obtain a JWT token:

    POST /authenticate
    
    {
        "userid" OR "email": ...
        "password": ...
    }

If login details are correct, then the server will reply with a JWT token. The client then must incldue the token
in all subsequent API requests, either in the request body as

    {
        ...
        token: ...
    }

or in HTTP header

    X-ACCESS-TOKEN: ...

Tokens are valid for 1 month.
Userid "admin" is always available and has unlimited access permissions, see password in separate mail.

## Get all entities in a collection
    GET /:collection    
*Note:* Currently disabled for /image, in order to avoid very large responses.

### Examples:
    GET /user
    GET /medicine

## Get any specific entity
    GET /:collection/:entity_id

### Examples:
    GET /user/user765  # See userid below
    GET /medicine/x9999
    GET /image/myimage.png

## Update Existing Entity
    POST /:collection/:entityID
    
    Content-Type:application/json
    
In the JSON body, include the properties that you wish to OVERWRITE. 
See next descriptions of available collections and entity details.

## Create New Image
    PUT /image
    Content-Type:application/json
    
    {
      "image_id": <<<UNIQUE among images>>> ascii128 String,
      "format": ascii128 String, e.g. "png" or "jpg".
      "contents": base64-encoded String
    }
    
### Example
    PUT /image
    Content-Type:application/json
    
    {
      "image_id": "bobsponge",
      "format": "gif".
      "contents": "aHi32...t="
    }


## Add New Medicine
    PUT /medicine
    Content-Type:application/json
    
    {
      medicine_id: <<<UNIQUE among medicine>>> ascii128 encoded,
      medicine_names: [ascii128 encoded],
      images: [image_id],
      route_of_administration: ascii128 encoded,
      dosage_form: ascii128 encoded,
      manufacturer: ascii128 encoded,
      basic_dose: ascii128 encoded
    }

### Example Medicine
    
    {
      medicine_id: "3334123",
      images: [],
      route_of_administration: "oral",
      dosage_form: "tablets"
    }

## Create New User
    PUT /user
    Content-Type:application/json
    
    {
      name: [forname, middlename0, middlename1, ..., surname],  # forname and surname are required, middlenames optional.
      email: <<<UNIQUE among users>>>  RFC 822 address
      password: ascii128 encoded,
    }
    
The server assigns to each new user a unique, automatically generated userid.

## Update Existing User
Following are all the details you may update for a user, whether he/she is a patient or a caretaker.

    POST /user/<userid>
    Content-Type:application/json
    
    {
        push_tokens: [ascii128 encoded],
        name: [forname, middlename0, middlename1, ..., surname],
        password: ascii128 encoded,
        email: <<<UNIQUE among users>>>  RFC 822 address
        patients: [userid],
        medical_info: {
              medication: [{
                  medicine_id: ascii128 string,
                  dosage_size: positive number,
                  frequency: [{ // Same format as for cron jobs
                      day_of_week: ...,
                      month_of_year: ...,
                      day_of_month: ...,
                      hour: ...,
                      minute: ...
                  }]
              }]
        }
    }

For now, users can freely add other users as patients. At a later stage, patients will be added through a more secure mechanism.

Note that when updating an entity, every specified field is COMPLETELY OVERWRITTEN.
So if you wish to preserve existing information, first GET the information, then RE-POST it along with new information. 
This applies also for updating medication for a user.

### Example Users: Patient and Caretaker
Yehoram is a patient who takes only one medicine: every day at 08:15pm, as well as every Tuesday and Saturday at 09:00am.

    {
      "userid": "user123",  # Was automatically generated by the server.
      "name": ["yehoram", "malkishua", "gaon"],
      "password": ...,
      "email": "yehoram.malkishua.gaon@pmail.com",
      "patients": [],
      "medical_info": {
          medication: [{
            medicine_id: "3334123",
            dosage_size: 2,
            frequency: [
                {"*", "*", "*", "20", "15"}, 
                {"3,7", "*", "*", "09", "00"}]
          }]
      }
    }
    
Zion is Yehoram's caretaker:

    {
      "userid": "user999",  # Was automatically generated by the server
      "name": ["Zion", "Coolness"],
      "password": ...,
      "email": "zion@coolness.co.il",
      "patients": ["user123"]
    }

## Get Caretakers of Patient

    GET /caretakers/:userid
    
Where userid identifies the patient.
The server will reply with all caretakers of the patient, in the following JSON body:
    
    [
        {"userid": ..., "name": ..., "email": ...},
    ]
    
 ### Example
 Yehoram requests
 
    GET /caretakers
    
    X-ACCESS-TOKEN: <a JWT token which Yehoram obtained eralier>
 
 The server responds with JSON body:
 
    [
       { 
        "userid": "user999", 
        "name": ["Zion", "Coolness"], 
        "email": "zion@coolness.co.il" 
       }
    ]

## Indication of Medicine Taken
    POST /takenmedicine
    
    {
        "when": ISO 8601 date-time,
        "medicine_id": ...,
        "dosage": ...
    }

### Example of taken medicine
    POST /takenmedicine
    
    {
        "when": "2017-05-14T09:30:00Z",
        "medicine_id": "z12345",
        "dosage": 1
    }

## Query taken medicine
    GET /takenmedicine/:userid?latest=<number>
    
The server will respond with the latest <number> records of medicine taken by userid.
If parameter latest is omitted, defaults to all records.

## Push or Pull Notifications
TBD. Note that push_tokens is already available for each user.
